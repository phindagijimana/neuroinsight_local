#!/bin/bash
# NeuroInsight Launcher - Terminal-agnostic wrapper
# Avoids VS Code/Cursor terminal corruption issues

# Detect if we're in a problematic terminal environment
if [[ "$TERM_PROGRAM" == "vscode" ]] || [[ "$TERM_PROGRAM" == "vscode-insiders" ]] || [[ -n "$VSCODE_PID" ]]; then
            echo "Detected VS Code terminal environment"
    echo "Using Python-based startup to avoid corruption issues..."
    echo ""

    # Use Python directly to avoid terminal issues
    exec python3 start.sh "$@"
else
    # Use Python-based scripts for consistency
    case "$1" in
        start)
            echo "Starting NeuroInsight..."
            exec python3 start.sh
            ;;
        stop)
            echo "Stopping NeuroInsight..."
            exec python3 stop.sh "${@:2}"
            ;;
        status)
            echo "NeuroInsight Status..."
            exec ./status.sh
            ;;
        monitor)
            echo "NeuroInsight Monitoring..."
            exec ./monitor.sh "${@:2}"
            ;;
        license)
            echo "FreeSurfer License Management"
            if [ -f "license.txt" ]; then
                echo "License file found: license.txt"
                # Basic validation - check if it has content
                if [ $(wc -l < license.txt) -ge 4 ] && ! grep -q "REPLACE THIS EXAMPLE CONTENT" license.txt 2>/dev/null; then
                    echo "License appears to be valid"
                    echo ""
                    echo "To update license:"
                    echo "1. Replace license.txt with new license file"
                    echo "2. Restart NeuroInsight: ./neuroinsight stop && ./neuroinsight start"
                else
                    echo "Warning: License file exists but may contain example content"
                    echo ""
                    echo "To fix:"
                    echo "1. Visit: https://surfer.nmr.mgh.harvard.edu/registration.html"
                    echo "2. Download the real license.txt file"
                    echo "3. Replace the current license.txt file"
                fi
            else
                echo "No license file found"
                echo ""
                echo "To set up FreeSurfer license:"
                echo "1. Visit: https://surfer.nmr.mgh.harvard.edu/registration.html"
                echo "2. Register with your research email"
                echo "3. Download the license.txt file"
                echo "4. Place license.txt in this directory (same folder as NeuroInsight)"
                echo "5. Restart NeuroInsight: ./neuroinsight stop && ./neuroinsight start"
                echo ""
                echo "Note: Without license, NeuroInsight will use mock processing for demonstrations"
            fi
            ;;
        *)
            echo "NeuroInsight Control Script"
            echo ""
            echo "Usage: $0 {start|stop|status|monitor|license}"
            echo ""
            echo "Commands:"
            echo "  start   - Start all NeuroInsight services"
            echo "  stop    - Stop all NeuroInsight services"
            echo "  status  - Show system status"
            echo "  monitor - Advanced monitoring options"
            echo "  license - FreeSurfer license management"
            echo ""
            echo "Examples:"
            echo "  $0 start          # Start NeuroInsight"
            echo "  $0 stop           # Stop NeuroInsight"
            echo "  $0 stop --clear-stuck  # Stop and clear stuck jobs"
            echo "  $0 status         # Show system status"
            echo "  $0 license        # Check/setup FreeSurfer license"
            echo "  $0 monitor cleanup # Clean up orphaned processes"
            exit 1
            ;;
    esac
fi
