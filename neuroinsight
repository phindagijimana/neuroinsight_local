#!/bin/bash
# NeuroInsight Launcher - Terminal-agnostic wrapper
# Avoids VS Code/Cursor terminal corruption issues

# Detect if we're in a problematic terminal environment
if [[ "$TERM_PROGRAM" == "vscode" ]] || [[ "$TERM_PROGRAM" == "vscode-insiders" ]] || [[ -n "$VSCODE_PID" ]]; then
    # Special case for installation - needs regular terminal
    if [[ "$1" == "install" ]]; then
        echo "Installation requires a regular terminal (not VS Code terminal)"
        echo "Please run this command in a regular terminal:"
        echo "  ./neuroinsight install"
        exit 1
    fi

    echo "Detected VS Code terminal environment"
    echo "Using Python-based startup to avoid corruption issues..."
    echo ""

    # Use Python directly to avoid terminal issues
    exec python3 start.py "$@"
else
    # Use Python-based scripts for consistency
    case "$1" in
        start)
            echo "Starting NeuroInsight..."
            # Check if virtual environment exists
            if [ -f "venv/bin/activate" ]; then
                echo "Activating Python virtual environment..."
                exec venv/bin/python start.py
            else
                echo "Warning: Python virtual environment not found. Running with system Python..."
                exec python3 start.py
            fi
            ;;
        stop)
            echo "Stopping NeuroInsight..."
            # Check if virtual environment exists
            if [ -f "venv/bin/activate" ]; then
                exec venv/bin/python stop.py "${@:2}"
            else
                exec python3 stop.py "${@:2}"
            fi
            ;;
        status)
            echo "NeuroInsight Status..."
            exec ./status.sh
            ;;
        monitor)
            echo "NeuroInsight Monitoring..."
            exec ./monitor.sh "${@:2}"
            ;;
        license)
            echo "FreeSurfer License Management"
            if [ -f "license.txt" ]; then
                echo "License file found: license.txt"
                # Basic validation - check if it has content
                if [ $(wc -l < license.txt) -ge 4 ] && ! grep -q "REPLACE THIS EXAMPLE CONTENT" license.txt 2>/dev/null; then
                    echo "License appears to be valid"
                    echo ""
                    echo "To update license:"
                    echo "1. Replace license.txt with new license file"
                    echo "2. Restart NeuroInsight: ./neuroinsight stop && ./neuroinsight start"
                else
                    echo "Warning: License file exists but may contain example content"
                    echo ""
                    echo "To fix:"
                    echo "1. Visit: https://surfer.nmr.mgh.harvard.edu/registration.html"
                    echo "2. Download the real license.txt file"
                    echo "3. Replace the current license.txt file"
                fi
            else
                echo "No license file found"
                echo ""
                echo "To set up FreeSurfer license:"
                echo "1. Visit: https://surfer.nmr.mgh.harvard.edu/registration.html"
                echo "2. Register with your research email"
                echo "3. Download the license.txt file"
                echo "4. Place license.txt in this directory (same folder as NeuroInsight)"
                echo "5. Restart NeuroInsight: ./neuroinsight stop && ./neuroinsight start"
                echo ""
                echo "Note: Without license, NeuroInsight will use mock processing for demonstrations"
            fi
            ;;
        install)
            echo "NeuroInsight Installation"
            if [ -f "install.sh" ]; then
                echo "Running installation script..."
                exec ./install.sh
            else
                echo "Error: install.sh not found in current directory"
                echo "Please ensure you're in the NeuroInsight project directory"
                exit 1
            fi
            ;;
        *)
            echo "NeuroInsight Control Script"
            echo ""
            echo "Usage: $0 {install|start|stop|status|monitor|license}"
            echo ""
            echo "Commands:"
            echo "  install - Run NeuroInsight installation"
            echo "  start   - Start all NeuroInsight services"
            echo "  stop    - Stop all NeuroInsight services"
            echo "  status  - Show system status"
            echo "  monitor - Advanced monitoring options"
            echo "  license - FreeSurfer license management"
            echo ""
            echo "Examples:"
            echo "  $0 install        # Install NeuroInsight"
            echo "  $0 start          # Start NeuroInsight"
            echo "  $0 stop           # Stop NeuroInsight"
            echo "  $0 stop --clear-stuck  # Stop and clear stuck jobs"
            echo "  $0 status         # Show system status"
            echo "  $0 license        # Check/setup FreeSurfer license"
            echo "  $0 monitor cleanup # Clean up orphaned processes"
            exit 1
            ;;
    esac
fi
